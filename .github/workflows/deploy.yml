name: Blue-Green Deploy

on:
  push:
    branches:
      - main

jobs:
  validate:
    name: Validate Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check required files
        run: |
          files=(index.html shop.html about.html gallery.html checkout.html product-dark-brown.html product-soft-black.html product-definer-duo.html product-brow-gel.html product-microblade.html product-brow-oil.html)
          for f in "${files[@]}"; do
            [ -f "$f" ] && echo "‚úÖ $f" || { echo "‚ùå MISSING: $f"; exit 1; }
          done

  deploy-blue:
    name: Deploy to Blue Server
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Blue via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/olabrows.store
            git pull origin main
            sudo chown -R ec2-user:ec2-user /var/www/olabrows.store
            sudo nginx -t && sudo systemctl reload nginx
            echo "‚úÖ Blue deployed!"
      - name: Health check Blue
        run: |
          sleep 5
          STATUS=$(curl -sk -o /dev/null -w "%{http_code}" https://olabrows.store)
          echo "Blue status: HTTP $STATUS"

  deploy-green:
    name: Deploy to Green Server
    runs-on: ubuntu-latest
    needs: deploy-blue
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Green via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_GREEN_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/olabrows.store
            git pull origin main
            sudo chown -R ec2-user:ec2-user /var/www/olabrows.store
            sudo nginx -t && sudo systemctl reload nginx
            echo "‚úÖ Green deployed!"
      - name: Summary
        run: |
          echo "üîµ Blue: https://olabrows.store (Primary)"
          echo "üü¢ Green: http://${{ secrets.VPS_GREEN_HOST }} (Standby)"
          echo "üîÑ Route 53 auto-switches if Blue fails"
