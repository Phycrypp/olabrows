name: Blue-Green Deploy

on:
  push:
    branches:
      - main

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: VALIDATE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: Validate Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "ğŸ“‹ Checking required files..."
          files=(
            "index.html"
            "shop.html"
            "about.html"
            "gallery.html"
            "checkout.html"
            "product-dark-brown.html"
            "product-soft-black.html"
            "product-definer-duo.html"
            "product-brow-gel.html"
            "product-microblade.html"
            "product-brow-oil.html"
          )
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              echo "  âœ… $f"
            else
              echo "  âŒ MISSING: $f"
              exit 1
            fi
          done
          echo ""
          echo "âœ… All files validated!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: DEPLOY TO BLUE (Primary)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-blue:
    name: Deploy to Blue Server
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Blue via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ”µ Deploying to Blue server..."
            cd /var/www/olabrows.store
            git pull origin main
            sudo chown -R ec2-user:ec2-user /var/www/olabrows.store
            sudo chmod -R 755 /var/www/olabrows.store
            sudo nginx -t
            sudo systemctl reload nginx
            echo "âœ… Blue server deployment complete!"

      - name: Health check Blue
        run: |
          echo "ğŸ” Checking Blue server health..."
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }} || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Blue server healthy! HTTP $STATUS"
          else
            echo "âŒ Blue server unhealthy! HTTP $STATUS"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: DEPLOY TO GREEN (Secondary)
  # Only runs if Blue deployment succeeds
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-green:
    name: Deploy to Green Server
    runs-on: ubuntu-latest
    needs: deploy-blue
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Green via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_GREEN_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸŸ¢ Deploying to Green server..."
            cd /var/www/olabrows.store
            git pull origin main
            sudo chown -R ec2-user:ec2-user /var/www/olabrows.store
            sudo chmod -R 755 /var/www/olabrows.store
            sudo nginx -t
            sudo systemctl reload nginx
            echo "âœ… Green server deployment complete!"

      - name: Health check Green
        run: |
          echo "ğŸ” Checking Green server health..."
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_GREEN_HOST }} || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Green server healthy! HTTP $STATUS"
          else
            echo "âš ï¸  Green server returned HTTP $STATUS"
          fi

      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸŒ¸ Browed by OlÃ¡ â€” Blue-Green Deploy!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Branch:  ${{ github.ref_name }}"
          echo "  Commit:  ${{ github.sha }}"
          echo "  Author:  ${{ github.actor }}"
          echo "  Message: ${{ github.event.head_commit.message }}"
          echo "  Time:    $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ”µ Blue:  https://olabrows.store (Primary)"
          echo "  ğŸŸ¢ Green: http://${{ secrets.VPS_GREEN_HOST }} (Standby)"
          echo "  ğŸ”„ Failover: Route 53 auto-switches if Blue fails"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
